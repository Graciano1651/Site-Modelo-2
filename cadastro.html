<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <script src="supabase.js"></script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastro de Funcionários</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="logo">
        <i class="fas fa-umbrella-beach"></i>
        <span>Cadastro Férias</span>
      </div>
      <div class="nav-links">
        <a href="cadastro.html"><i class="fas fa-user-plus"></i> Cadastro</a>
        <a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        <button id="themeToggle" class="btn-theme"><i class="fas fa-moon"></i></button>
      </div>
    </div>

    <div class="content">
      <h1><i class="fas fa-user-edit"></i> Cadastro de Funcionário</h1>

      <form id="employeeForm" class="form-grid">
        <input type="hidden" id="employeeId"/>

        <div class="form-group">
          <label for="name"><i class="fas fa-user"></i> Nome Completo</label>
          <input type="text" id="name" class="form-control" required />
        </div>

        <div class="form-group">
          <label for="matricula"><i class="fas fa-id-card"></i> Matrícula</label>
          <input type="text" id="matricula" class="form-control" required />
        </div>

        <div class="form-group">
          <label for="phone"><i class="fas fa-phone"></i> Telefone</label>
          <input type="tel" id="phone" class="form-control" required />
        </div>

        <div class="form-group">
          <label for="hireDate"><i class="fas fa-calendar-alt"></i> Data de Contratação</label>
          <input type="date" id="hireDate" class="form-control" required />
        </div>

        <div class="form-group">
          <label for="status"><i class="fas fa-user-tag"></i> Status</label>
          <select id="status" class="form-control" required>
            <option value="">Selecione...</option>
            <option value="staff">Staff</option>
            <option value="operacional">Operacional</option>
            <option value="aprendiz">Aprendiz</option>
            <option value="suspenso">Suspenso</option>
          </select>
        </div>

        <div class="form-group">
          <label for="team"><i class="fas fa-users"></i> Frente de Trabalho</label>
          <select id="team" class="form-control" required>
            <option value="">Selecione...</option>
            <option value="A">Frente A</option>
            <option value="B">Frente B</option>
            <option value="C">Frente C</option>
            <option value="D">Frente D</option>
          </select>
        </div>

        <div class="photo-upload">
          <div class="photo-preview" id="photoPreview">
            <i class="fas fa-user"></i>
          </div>
          <button type="button" class="btn-upload" id="uploadBtn">
            <i class="fas fa-camera"></i> Adicionar Foto
          </button>
          <input type="file" id="photoInput" accept="image/*" style="display: none" />
        </div>

        <div class="form-group">
          <label for="lastVacation"><i class="fas fa-plane"></i> Últimas Férias</label>
          <input type="date" id="lastVacation" class="form-control" />
        </div>

        <div class="form-group">
          <label><i class="fas fa-clock"></i> Férias a Vencer</label>
          <div id="vacationCounter" class="status-indicator pending">
            <i class="fas fa-hourglass-half"></i> Calculo automático após cadastro
          </div>
        </div>

        <div class="form-group" style="grid-column: span 2;">
          <label><i class="fas fa-calendar-check"></i> Período de Férias (máx 30 dias)</label>
          <div class="vacation-days">
            <div>
              <input type="number" id="vacationDay1" class="form-control" placeholder="Dias" min="0" max="30" />
              <input type="date" id="vacationDate1" class="form-control" placeholder="Data" />
            </div>
            <div>
              <input type="number" id="vacationDay2" class="form-control" placeholder="Dias" min="0" max="30" />
              <input type="date" id="vacationDate2" class="form-control" placeholder="Data" />
            </div>
            <div>
              <input type="number" id="vacationDay3" class="form-control" placeholder="Dias" min="0" max="30" />
              <input type="date" id="vacationDate3" class="form-control" placeholder="Data" />
            </div>
          </div>
          <div id="totalDays" style="text-align: right; margin-top: 0.5rem; font-weight: 500;">
            <i class="fas fa-calculator"></i> Total: <span>0</span> dias
          </div>
        </div>

        <div class="actions">
          <button type="button" class="btn btn-secondary" id="clearBtn">
            <i class="fas fa-broom"></i> Limpar
          </button>
          <button type="button" class="btn btn-primary" id="saveButton">
            <i class="fas fa-save"></i> Salvar Funcionário
          </button>
          <button type="button" class="btn btn-danger" id="deleteBtn" style="display: none;">
            <i class="fas fa-trash"></i> Deletar Funcionário
          </button>
          <button type="button" class="btn btn-export" id="exportExcel">
            <i class="fas fa-file-excel"></i> Exportar Excel
          </button>
        </div>
        <button type="button" class="btn btn-primary" id="newUserBtn" style="display: none;">
          <i class="fas fa-user-plus"></i> Novo Usuário
        </button>

        <div class="employee-list">
          <h2><i class="fas fa-users"></i> Funcionários Cadastrados</h2>
          <input type="text" id="searchInput" placeholder="Buscar por nome ou matrícula" class="form-control" />
          <div class="table-responsive">
            <table id="employeesTable">
              <thead>
                <tr>
                  <th>Nome</th>
                  <th>Matrícula</th>
                  <th>Status</th>
                  <th>Frente</th>
                  <th>Férias</th>
                  <th>Ações</th>
                </tr>
              </thead>
              <tbody id="employeesList">
                <!-- Lista dinâmica -->
              </tbody>
            </table>
          </div>
        </div>
      </form>
    </div>
  </div>

  <div id="userModal" class="modal">
    <div class="modal-content">
      <span class="close">&times;</span>
      <h2><i class="fas fa-user-plus"></i> Cadastrar Novo Usuário</h2>
      <form id="userForm">
        <div class="form-group">
          <label for="newUsername">Usuário</label>
          <input type="text" id="newUsername" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="newPassword">Senha</label>
          <input type="password" id="newPassword" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="userType">Tipo de Usuário</label>
          <select id="userType" class="form-control" required>
            <option value="common">Usuário Comum</option>
            <option value="admin">Administrador</option>
          </select>
        </div>
      </form>
      <button type="button" class="btn btn-primary" id="saveUserBtn">
        <i class="fas fa-save"></i> Salvar Usuário
      </button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="utils.js"></script>
  <script>
    // Variável para armazenar a URL da foto
    let photoUrl = '';

    // Carrega funcionário para edição
    async function loadEmployeeForEdit() {
      const urlParams = new URLSearchParams(window.location.search);
      const employeeId = urlParams.get('id');
      if (!employeeId) return;

      try {
        const { data: employee, error } = await supabase
          .from('employees')
          .select('*')
          .eq('id', employeeId)
          .single();

        if (error) throw error;

        // Preenche o formulário
        document.getElementById('employeeId').value = employee.id;
        document.getElementById('name').value = employee.name || '';
        document.getElementById('matricula').value = employee.matricula || '';
        document.getElementById('phone').value = employee.phone || '';
        document.getElementById('hireDate').value = employee.hire_date || '';
        document.getElementById('status').value = employee.status || '';
        document.getElementById('team').value = employee.team || '';
        document.getElementById('lastVacation').value = employee.last_vacation || '';

        // Foto do funcionário
        if (employee.photo) {
          document.getElementById('photoPreview').innerHTML = `<img src="${employee.photo}" alt="Foto do funcionário">`;
          photoUrl = employee.photo;
        }

        // Mostra botões de controle
        document.getElementById('newUserBtn').style.display = 'block';
        document.getElementById('deleteBtn').style.display = 'block';

      } catch (error) {
        console.error('Erro ao carregar funcionário:', error);
      }
    }

    // Função para deletar funcionário
    async function deleteEmployee() {
      const employeeId = document.getElementById('employeeId').value;
      if (!employeeId) return;

      const result = await Swal.fire({
        title: 'Tem certeza?',
        text: "Você não poderá reverter isso!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Sim, deletar!'
      });

      if (result.isConfirmed) {
        try {
          // Deleta períodos de férias primeiro
          await supabase.from('vacation_periods').delete().eq('employee_id', employeeId);
          
          // Depois deleta o funcionário
          const { error } = await supabase.from('employees').delete().eq('id', employeeId);
          if (error) throw error;

          await Swal.fire('Deletado!', 'Funcionário removido com sucesso.', 'success');
          
          // Limpa o formulário
          document.getElementById('employeeForm').reset();
          document.getElementById('photoPreview').innerHTML = '<i class="fas fa-user"></i>';
          photoUrl = '';
          document.getElementById('employeeId').value = '';
          document.getElementById('deleteBtn').style.display = 'none';
          
          // Atualiza a lista
          if (window.loadEmployees) loadEmployees();

        } catch (error) {
          console.error('Erro ao deletar:', error);
          Swal.fire('Erro!', 'Não foi possível deletar o funcionário.', 'error');
        }
      }
    }

    // Evento para novo usuário
    document.getElementById('newUserBtn').addEventListener('click', () => {
      document.getElementById('employeeForm').reset();
      document.getElementById('photoPreview').innerHTML = '<i class="fas fa-user"></i>';
      photoUrl = '';
      document.getElementById('employeeId').value = '';
      document.getElementById('newUserBtn').style.display = 'none';
      document.getElementById('deleteBtn').style.display = 'none';
    });

    // Evento para deletar
    document.getElementById('deleteBtn').addEventListener('click', deleteEmployee);

    // Inicialização
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        await ensureSupabaseReady();
        
        // Verifica autenticação
        const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
        if (!currentUser) {
          window.location.href = 'login.html';
          return;
        }

        // Carrega funcionário para edição se houver ID
        await loadEmployeeForEdit();

        // Restante da inicialização existente...
        if (window.loadEmployees) await loadEmployees();

      } catch (error) {
        console.error('Erro na inicialização:', error);
        window.location.href = 'login.html';
      }
    });

    // Função auxiliar para garantir que o Supabase está pronto
    async function ensureSupabaseReady() {
      return new Promise((resolve) => {
        if (window.supabase) return resolve();
        document.addEventListener('supabase-ready', () => resolve());
      });
    }
  </script>
</body>
</html>